<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶é”™è¯¯æ•è·å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e5e5;
        }
        .status {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .status-card {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .status-card.error { background: #fee; border-left: 4px solid #f56565; }
        .status-card.warning { background: #fff3cd; border-left: 4px solid #ffc107; }
        .status-card.success { background: #d4edda; border-left: 4px solid #28a745; }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .log-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f9fa;
        }
        .log-entry {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }
        .log-entry.error { background: #fee; border-left: 3px solid #f56565; }
        .log-entry.warning { background: #fff3cd; border-left: 3px solid #ffc107; }
        .log-entry.info { background: #d1ecf1; border-left: 3px solid #17a2b8; }
        .timestamp { color: #666; font-size: 11px; }
        .error-type { font-weight: bold; color: #d63384; }
        .url { color: #0066cc; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” å®æ—¶é”™è¯¯æ•è·å·¥å…·</h1>
            <p>ä¸“é—¨ç”¨äºæ•è·å’Œåˆ†æ ERR_ABORTED å’Œ Failed to fetch é”™è¯¯</p>
        </div>

        <div class="status">
            <div class="status-card error">
                <h3>ERR_ABORTED</h3>
                <div id="aborted-count">0</div>
            </div>
            <div class="status-card warning">
                <h3>Failed to fetch</h3>
                <div id="fetch-failed-count">0</div>
            </div>
            <div class="status-card success">
                <h3>æˆåŠŸè¯·æ±‚</h3>
                <div id="success-count">0</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="testFamilyAPI()">æµ‹è¯•å®¶åº­API</button>
            <button class="btn btn-warning" onclick="testWithCancel()">æµ‹è¯•å–æ¶ˆè¯·æ±‚</button>
            <button class="btn btn-success" onclick="testConcurrent()">æµ‹è¯•å¹¶å‘è¯·æ±‚</button>
            <button class="btn btn-danger" onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
            <button class="btn btn-primary" onclick="exportLogs()">å¯¼å‡ºæ—¥å¿—</button>
        </div>

        <div class="log-container" id="log-container">
            <div class="log-entry info">
                <span class="timestamp">[å¯åŠ¨]</span> é”™è¯¯ç›‘æ§å·²å¯åŠ¨ï¼Œç­‰å¾…æ•è·é”™è¯¯...
            </div>
        </div>
    </div>

    <script>
        let errorCounts = {
            aborted: 0,
            fetchFailed: 0,
            success: 0
        };
        let logs = [];

        // æ›´æ–°è®¡æ•°å™¨æ˜¾ç¤º
        function updateCounters() {
            document.getElementById('aborted-count').textContent = errorCounts.aborted;
            document.getElementById('fetch-failed-count').textContent = errorCounts.fetchFailed;
            document.getElementById('success-count').textContent = errorCounts.success;
        }

        // æ·»åŠ æ—¥å¿—æ¡ç›®
        function addLog(type, message, details = {}) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                type,
                message,
                details,
                id: Date.now() + Math.random()
            };
            
            logs.push(logEntry);
            
            const logContainer = document.getElementById('log-container');
            const logDiv = document.createElement('div');
            logDiv.className = `log-entry ${type}`;
            
            let detailsStr = '';
            if (details.url) detailsStr += `<br><span class="url">URL: ${details.url}</span>`;
            if (details.status) detailsStr += `<br>çŠ¶æ€: ${details.status}`;
            if (details.error) detailsStr += `<br>é”™è¯¯: ${details.error}`;
            
            logDiv.innerHTML = `
                <span class="timestamp">[${timestamp}]</span>
                <span class="error-type">[${type.toUpperCase()}]</span>
                ${message}
                ${detailsStr}
            `;
            
            logContainer.appendChild(logDiv);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (logs.length > 100) {
                logs.shift();
                logContainer.removeChild(logContainer.children[1]); // ä¿ç•™ç¬¬ä¸€ä¸ªå¯åŠ¨æ¶ˆæ¯
            }
        }

        // æ‹¦æˆª fetch è¯·æ±‚
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            const url = args[0];
            const options = args[1] || {};
            
            addLog('info', `å‘èµ·è¯·æ±‚: ${url}`);
            
            try {
                const response = await originalFetch.apply(this, args);
                
                if (response.ok) {
                    errorCounts.success++;
                    addLog('info', `è¯·æ±‚æˆåŠŸ`, { url, status: response.status });
                } else {
                    addLog('warning', `HTTPé”™è¯¯`, { url, status: response.status });
                }
                
                updateCounters();
                return response;
            } catch (error) {
                console.error('Fetch error caught:', error);
                
                if (error.name === 'AbortError' || error.message.includes('aborted')) {
                    errorCounts.aborted++;
                    addLog('error', `ERR_ABORTED: è¯·æ±‚è¢«å–æ¶ˆ`, { url, error: error.message });
                } else if (error.message.includes('Failed to fetch') || error.message.includes('fetch')) {
                    errorCounts.fetchFailed++;
                    addLog('error', `Failed to fetch: ç½‘ç»œè¯·æ±‚å¤±è´¥`, { url, error: error.message });
                } else {
                    addLog('error', `å…¶ä»–ç½‘ç»œé”™è¯¯: ${error.message}`, { url, error: error.message });
                }
                
                updateCounters();
                throw error;
            }
        };

        // æ•è·å…¨å±€é”™è¯¯
        window.addEventListener('error', (event) => {
            console.error('Global error caught:', event.error);
            addLog('error', `å…¨å±€é”™è¯¯: ${event.error?.message || event.message}`, {
                error: event.error?.stack || event.error?.message
            });
        });

        // æ•è·æœªå¤„ç†çš„ Promise æ‹’ç»
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            
            const reason = event.reason;
            if (reason?.name === 'AbortError' || reason?.message?.includes('aborted')) {
                errorCounts.aborted++;
                addLog('error', `æœªå¤„ç†çš„ ERR_ABORTED`, { error: reason.message });
            } else if (reason?.message?.includes('Failed to fetch')) {
                errorCounts.fetchFailed++;
                addLog('error', `æœªå¤„ç†çš„ Failed to fetch`, { error: reason.message });
            } else {
                addLog('error', `æœªå¤„ç†çš„ Promise æ‹’ç»: ${reason?.message || reason}`, {
                    error: reason?.stack || reason?.message || reason
                });
            }
            
            updateCounters();
        });

        // æµ‹è¯•å‡½æ•°
        async function testFamilyAPI() {
            addLog('info', 'å¼€å§‹æµ‹è¯•å®¶åº­ç®¡ç†API...');
            
            const endpoints = [
                'http://localhost:5173/api/family/members',
                'http://localhost:5173/api/family/invites',
                'https://home-list-api.zhangkaishen.workers.dev/api/family/members',
                'https://home-list-api.zhangkaishen.workers.dev/api/family/invites'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    await fetch(endpoint, {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer test-token',
                            'Content-Type': 'application/json'
                        }
                    });
                } catch (error) {
                    // é”™è¯¯å·²ç»è¢«æ‹¦æˆªå™¨å¤„ç†
                }
                
                // ç­‰å¾…ä¸€ä¸‹å†æµ‹è¯•ä¸‹ä¸€ä¸ª
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        async function testWithCancel() {
            addLog('info', 'æµ‹è¯•å–æ¶ˆè¯·æ±‚...');
            
            const controller = new AbortController();
            
            // 1ç§’åå–æ¶ˆè¯·æ±‚
            setTimeout(() => {
                controller.abort();
                addLog('warning', 'æ‰‹åŠ¨å–æ¶ˆäº†è¯·æ±‚');
            }, 1000);
            
            try {
                await fetch('https://home-list-api.zhangkaishen.workers.dev/api/family/members', {
                    signal: controller.signal,
                    headers: {
                        'Authorization': 'Bearer test-token'
                    }
                });
            } catch (error) {
                // é”™è¯¯å·²ç»è¢«æ‹¦æˆªå™¨å¤„ç†
            }
        }

        async function testConcurrent() {
            addLog('info', 'æµ‹è¯•å¹¶å‘è¯·æ±‚...');
            
            const promises = [];
            for (let i = 0; i < 5; i++) {
                promises.push(
                    fetch('https://home-list-api.zhangkaishen.workers.dev/api/family/members', {
                        headers: {
                            'Authorization': 'Bearer test-token'
                        }
                    }).catch(() => {}) // å¿½ç•¥é”™è¯¯ï¼Œè®©æ‹¦æˆªå™¨å¤„ç†
                );
            }
            
            await Promise.allSettled(promises);
            addLog('info', 'å¹¶å‘æµ‹è¯•å®Œæˆ');
        }

        function clearLogs() {
            logs = [];
            errorCounts = { aborted: 0, fetchFailed: 0, success: 0 };
            updateCounters();
            
            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML = `
                <div class="log-entry info">
                    <span class="timestamp">[æ¸…é™¤]</span> æ—¥å¿—å·²æ¸…é™¤ï¼Œé‡æ–°å¼€å§‹ç›‘æ§...
                </div>
            `;
        }

        function exportLogs() {
            const data = {
                timestamp: new Date().toISOString(),
                counts: errorCounts,
                logs: logs
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `error-logs-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            addLog('info', 'æ—¥å¿—å·²å¯¼å‡º');
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¼€å§‹ç›‘æ§
        window.addEventListener('load', () => {
            addLog('info', 'é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹ç›‘æ§ç½‘ç»œè¯·æ±‚...');
            
            // è‡ªåŠ¨æµ‹è¯•ä¸€æ¬¡
            setTimeout(() => {
                addLog('info', 'è‡ªåŠ¨å¼€å§‹æµ‹è¯•...');
                testFamilyAPI();
            }, 2000);
        });

        // å®šæœŸæ›´æ–°æ˜¾ç¤º
        setInterval(updateCounters, 1000);
    </script>
</body>
</html>